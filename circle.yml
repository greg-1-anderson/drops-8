# https://circleci.com/docs/configuration#machine
machine:
  php:
    # https://circleci.com/docs/environment#php
    version: 7.0.7
  environment:
    # DB config. Using default CircleCI's database.
    TERMINUS_ENV: ci-$CIRCLE_BUILD_NUM
    TERMINUS_SITE: ci-drops-8
    PATH: $PATH:~/.composer/vendor/bin
    TESTING_DIR: /tmp/ci-drops-8

dependencies:
  cache_directories:
    - ~/.composer/cache
  pre:
    # Set the PHP timezone so that Behat script does not fail.
    # Using > instead of >> will overwrite the file and disable xdebug.
    # xdebug makes composer slower.
    - echo "date.timezone = 'US/Central'"  >  /opt/circleci/php/7.0.7/etc/conf.d/xdebug.ini
  override:
    - composer global require "hirak/prestissimo:^0.3"
    - composer global require "pantheon-systems/terminus:>=0.13.3"
    - composer global require drush/drush:8.*
    - git clone git@github.com:pantheon-systems/ci-drops-8.git $TESTING_DIR
    - cd $TESTING_DIR && composer install
    #- composer config repositories.ci-drops-8 vcs git@github.com:pantheon-systems/ci-drops-8.git
    #- composer global require pantheon-systems/ci-drops-8
  post:
    - terminus auth login --machine-token=$TERMINUS_TOKEN
    - terminus site create-env --to-env=$TERMINUS_ENV --from-env=dev
    - git remote add pantheon $(terminus site connection-info --field=git_url)
    - git fetch pantheon
    - git checkout -b $TERMINUS_ENV
    - git push pantheon $TERMINUS_ENV -f
    - terminus site set-connection-mode --mode=sftp
test:
  pre:
    #- ./vendor/bin/phpcs --report=full --extensions=php,module,inc,theme,info,install --standard=vendor/drupal/coder/coder_sniffer/Drupal . --ignore=vendor,modules,core,drush,patches,tests
    # Make a new multidev env from a vanilla D8 site.
    #- cd tests/circle-scripts && ./create-fresh-d8-site.sh
  override:
    - cd $TESTING_DIR && ./vendor/bin/behat
   # - cd tests/circle-scripts && ./verify-solr.sh
